name: Docker CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

env:
  IMAGE_NAME: selfproxy
  IMAGE_TAG: ${{ github.sha }}

jobs:
  hadolint:
    name: Hadolint - Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Hadolint
        id: hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error
          format: json
          output-file: hadolint-report.json
        continue-on-error: true

      - name: Summary - Hadolint
        if: always()
        run: |
          echo "## ðŸ³ Hadolint - Dockerfile Lint" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f hadolint-report.json ] || [ "$(cat hadolint-report.json)" = "[]" ] || [ "$(cat hadolint-report.json)" = "" ]; then
            echo "âœ… **No issues found!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Level | Rule | Line | Message |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|------|------|---------|" >> $GITHUB_STEP_SUMMARY
            cat hadolint-report.json | jq -r '.[] | "| \(.level) | \(.code) | \(.line) | \(.message) |"' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if Hadolint found errors
        if: steps.hadolint.outcome == 'failure'
        run: exit 1

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: hadolint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save image to tarball
        run: docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -o image.tar

      - name: Image size summary
        run: |
          SIZE=$(du -sh image.tar | cut -f1)
          echo "## ðŸ—ï¸ Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tarball size | $SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| Git SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1

  dockle:
    name: Dockle - CIS Benchmark
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image
        run: docker load -i image.tar

      - name: Install Dockle
        run: |
          VERSION=$(curl -s https://api.github.com/repos/goodwithtech/dockle/releases/latest \
            | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -fsSL -o dockle.tar.gz \
            "https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.tar.gz"
          tar -xzf dockle.tar.gz dockle
          chmod +x dockle
          sudo mv dockle /usr/local/bin/dockle

      - name: Run Dockle
        run: |
          dockle \
            --ignore DKL-DI-0004 \
            --format json \
            --output dockle-report.json \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} || true

      - name: Summary - Dockle
        if: always()
        run: |
          echo "## ðŸ” Dockle - CIS Benchmark" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f dockle-report.json ]; then
            echo "âš ï¸ Report not generated." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          FATAL=$(cat dockle-report.json | jq '[.details[] | select(.level == "FATAL")] | length')
          WARN=$(cat dockle-report.json  | jq '[.details[] | select(.level == "WARN")]  | length')
          INFO=$(cat dockle-report.json  | jq '[.details[] | select(.level == "INFO")]  | length')

          if [ "$FATAL" = "0" ] && [ "$WARN" = "0" ]; then
            STATUS="âœ… Passed"
          elif [ "$FATAL" != "0" ]; then
            STATUS="âŒ Failed"
          else
            STATUS="âš ï¸ Warnings"
          fi

          echo "**Status: $STATUS**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Fatal | $FATAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Warn  | $WARN  |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Info  | $INFO  |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DETAILS=$(cat dockle-report.json | jq -r '.details[] | select(.level != "INFO") | "| \(.level) | \(.code) | \(.title) |"')
          if [ -n "$DETAILS" ]; then
            echo "| Level | Code | Title |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "$DETAILS" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Dockle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dockle-report
          path: dockle-report.json

  dive:
    name: Dive - Image Efficiency
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image
        run: docker load -i image.tar

      - name: Install Dive
        run: |
          VERSION=$(curl -s https://api.github.com/repos/wagoodman/dive/releases/latest \
            | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -fsSL -o dive.tar.gz \
            "https://github.com/wagoodman/dive/releases/download/v${VERSION}/dive_${VERSION}_linux_amd64.tar.gz"
          tar -xzf dive.tar.gz dive
          chmod +x dive
          sudo mv dive /usr/local/bin/dive

      - name: Checkout (for .dive-ci.yml)
        uses: actions/checkout@v4

      - name: Run Dive
        run: |
          CI=true dive \
            --ci-config .dive-ci.yml \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            2>&1 | tee dive-report.txt || true

      - name: Summary - Dive
        if: always()
        run: |
          echo "## ðŸ¤¿ Dive - Image Efficiency" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f dive-report.txt ]; then
            echo "âš ï¸ Report not generated." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          EFFICIENCY=$(grep -oP 'efficiency: \K[\d.]+' dive-report.txt | head -1 || echo "N/A")
          WASTED=$(grep -oP 'wastedBytes: \K[^\n]+' dive-report.txt | head -1 || echo "N/A")
          RESULT=$(grep -E "^Result:(PASS|FAIL)" dive-report.txt | tail -1 || echo "N/A")

          if echo "$RESULT" | grep -q "Result:PASS"; then
            STATUS="âœ… Passed"
          elif echo "$RESULT" | grep -q "Result:FAIL"; then
            STATUS="âŒ Failed"
          else
            STATUS="âš ï¸ Unknown"
          fi

          echo "**Status: $STATUS**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Efficiency score | $EFFICIENCY |" >> $GITHUB_STEP_SUMMARY
          echo "| Wasted space | $WASTED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Full Dive output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat dive-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload Dive report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dive-report
          path: dive-report.txt

  trivy:
    name: Trivy - Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image
        run: docker load -i image.tar

      - name: Run Trivy (JSON for summary)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: json
          output: trivy-report.json
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          exit-code: "0"

      - name: Run Trivy (SARIF for Security tab)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-results.sarif
          exit-code: "0"

      - name: Summary - Trivy
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Trivy - Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f trivy-report.json ]; then
            echo "âš ï¸ Report not generated." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          CRITICAL=$(cat trivy-report.json | jq '[.. | objects | select(has("Vulnerabilities")) | .Vulnerabilities // [] | .[] | select(.Severity=="CRITICAL")] | length')
          HIGH=$(cat trivy-report.json     | jq '[.. | objects | select(has("Vulnerabilities")) | .Vulnerabilities // [] | .[] | select(.Severity=="HIGH")]     | length')
          MEDIUM=$(cat trivy-report.json   | jq '[.. | objects | select(has("Vulnerabilities")) | .Vulnerabilities // [] | .[] | select(.Severity=="MEDIUM")]   | length')
          LOW=$(cat trivy-report.json      | jq '[.. | objects | select(has("Vulnerabilities")) | .Vulnerabilities // [] | .[] | select(.Severity=="LOW")]      | length')
          UNKNOWN=$(cat trivy-report.json  | jq '[.. | objects | select(has("Vulnerabilities")) | .Vulnerabilities // [] | .[] | select(.Severity=="UNKNOWN")]  | length')
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW + UNKNOWN))

          if [ "$CRITICAL" != "0" ] || [ "$HIGH" != "0" ]; then
            STATUS="âŒ Action required"
          elif [ "$TOTAL" = "0" ]; then
            STATUS="âœ… Clean"
          else
            STATUS="âš ï¸ Minor findings"
          fi

          echo "**Status: $STATUS** â€” $TOTAL total vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High     | $HIGH     |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium   | $MEDIUM   |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Low      | $LOW      |" >> $GITHUB_STEP_SUMMARY
          echo "| âšª Unknown  | $UNKNOWN  |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VULNS=$(cat trivy-report.json | jq -r '
            [.. | objects | select(has("Vulnerabilities")) | .Vulnerabilities // [] | .[]] |
            sort_by(.Severity) | reverse |
            .[] |
            "| \(.Severity) | \(.VulnerabilityID) | \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "N/A") | \(.Title // "N/A") |"
          ')

          if [ -n "$VULNS" ]; then
            echo "| Severity | CVE | Package | Installed | Fixed | Title |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-----|---------|-----------|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "$VULNS" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: |
            trivy-report.json
            trivy-results.sarif

      - name: Upload Trivy SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true